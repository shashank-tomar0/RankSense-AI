<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- Google Fonts: JetBrains Mono for that coding vibe -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <title>RankSense.AI // ENTERPRISE_CORE</title>

    <style>
        :root {
            --neon-green: #0aff0a;
            --dark-green: #003300;
            --bg-black: #050505;
            --grid-line: #001a00;
        }

        body {
            background-color: var(--bg-black);
            color: var(--neon-green);
            font-family: 'JetBrains Mono', monospace;
            background-image:
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* CRT Scanline Effect */
        .scanlines::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 50;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        .glow-text {
            text-shadow: 0 0 5px var(--neon-green);
        }

        .hacker-border {
            border: 1px solid var(--neon-green);
            box-shadow: 0 0 10px var(--dark-green);
        }

        /* Glitch Animation */
        @keyframes glitch {
            0% {
                transform: translate(0);
            }

            20% {
                transform: translate(-2px, 2px);
            }

            40% {
                transform: translate(-2px, -2px);
            }

            60% {
                transform: translate(2px, 2px);
            }

            80% {
                transform: translate(2px, -2px);
            }

            100% {
                transform: translate(0);
            }
        }

        .glitch:hover {
            animation: glitch 0.2s cubic-bezier(.25, .46, .45, .94) both infinite;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--neon-green);
            border-radius: 0;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark-green);
        }

        .modal-bg {
            background: rgba(0, 20, 0, 0.95);
            backdrop-filter: blur(5px);
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden scanlines">

    <!-- Header -->
    <header class="p-4 border-b border-green-900 flex justify-between items-center bg-black/80 backdrop-blur z-10">
        <div class="flex items-center gap-4">
            <div class="w-3 h-3 bg-green-500 animate-pulse rounded-full"></div>
            <h1 class="text-2xl font-bold tracking-widest glow-text glitch cursor-default">RANKSENSE<span
                    class="opacity-50">_ENTERPRISE</span></h1>
        </div>
        <div class="text-xs space-x-4 opacity-70">
            <span>MEM: <span id="mem-usage">24GB</span></span>
            <span>NET: <span id="net-status" class="text-green-500">ONLINE</span></span>
            <span>UPTIME: <span id="uptime">00:00:00</span></span>
            <button onclick="exportCSV()"
                class="border border-green-500 px-2 py-1 text-[10px] hover:bg-green-900 transition-colors">>>>
                EXPORT_REPORT</button>
        </div>
    </header>

    <!-- Main Grid -->
    <main class="flex-1 grid grid-cols-12 gap-0 overflow-hidden relative">

        <!-- Left Panel: Upload & Radar -->
        <aside
            class="col-span-12 lg:col-span-4 border-r border-green-900 flex flex-col bg-black/50 p-6 gap-6 overflow-y-auto z-10">

            <!-- Upload Module -->
            <div class="hacker-border p-6 text-center cursor-pointer hover:bg-green-900/10 transition-colors group relative overflow-hidden"
                onclick="document.getElementById('fileInput').click()">
                <div class="absolute top-0 left-0 w-2 h-2 border-t border-l border-green-500"></div>
                <div class="absolute bottom-0 right-0 w-2 h-2 border-b border-r border-green-500"></div>

                <div class="text-4xl mb-4 opacity-80 group-hover:scale-110 transition-transform">>>>_INGEST</div>
                <p class="text-xs tracking-widest uppercase">Upload Candidate Dossiers</p>
                <p class="text-[10px] opacity-50 mt-2">Format: PDF/DOCX</p>
                <p class="text-[10px] opacity-50 mt-2">Format: PDF/DOCX</p>
                <input type="file" id="fileInput" class="hidden" multiple onchange="handleFiles(this.files)">
            </div>

            <!-- JD Input -->
            <div class="hacker-border p-4">
                <h3 class="text-sm font-bold border-b border-green-900 pb-2 mb-2">/// TARGET_PROFILE (JD)</h3>
                <textarea id="jdInput"
                    class="w-full h-24 bg-black border border-green-900 text-[10px] p-2 text-green-500 focus:outline-none focus:border-green-500 placeholder-green-900"
                    placeholder="PASTE_JOB_DESCRIPTION_HERE..."></textarea>
            </div>

            <!-- Radar Chart -->
            <div class="hacker-border p-4 flex-1 min-h-[350px] relative">
                <h3 class="text-sm font-bold border-b border-green-900 pb-2 mb-4">/// COMPETENCY_MATRIX</h3>
                <div class="relative h-64">
                    <canvas id="radarChart"></canvas>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-2 text-[10px]">
                    <div class="flex justify-between"><span>INTERNSHIPS:</span> <span id="stat-intern"
                            class="font-bold">0</span></div>
                    <div class="flex justify-between"><span>PROJECTS:</span> <span id="stat-proj"
                            class="font-bold">0</span></div>
                    <div class="flex justify-between"><span>SKILLS:</span> <span id="stat-skill"
                            class="font-bold">0</span></div>
                    <div class="flex justify-between"><span>CGPA:</span> <span id="stat-cgpa"
                            class="font-bold">0.0</span></div>
                </div>
            </div>

            <!-- Team Xnords Branding -->
            <div class="mt-auto pt-4 border-t border-green-900/30 text-center opacity-50 text-[10px]">
                <p>ENGINEERED BY <span class="font-bold text-green-400">TEAM XNORDS</span></p>
                <p>HACKATHON_V2026 // PRODUCTION_BUILD</p>
            </div>
        </aside>

        <!-- Right Panel: Matrix & Output -->
        <section class="col-span-12 lg:col-span-8 flex flex-col bg-black/20 relative z-0">

            <!-- Matrix Rain Canvas Background -->
            <div class="absolute inset-0 pointer-events-none opacity-10"
                style="background: repeating-linear-gradient(0deg, transparent, transparent 19px, #0f0 20px);"></div>

            <!-- Table Header -->
            <div class="p-4 border-b border-green-900 bg-green-900/5 flex justify-between items-center">
                <h2 class="text-sm font-bold uppercase">/// CANDIDATE_REGISTRY</h2>
                <div class="text-[10px]">RECORDS: <span id="record-count">0</span></div>
            </div>

            <!-- Results Table -->
            <div class="flex-1 overflow-y-auto p-4">
                <table class="w-full text-left text-xs font-mono border-collapse">
                    <thead class="text-green-700 border-b border-green-800">
                        <tr>
                            <th class="p-2">#RANK</th>
                            <th class="p-2">FILENAME</th>
                            <th class="p-2">PERFORMANCE_INDEX</th>
                            <th class="p-2 w-1/3">KEY_SIGNATURES</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTable" class="divide-y divide-green-900/30">
                        <!-- Rows injected here -->
                    </tbody>
                </table>
            </div>

            <!-- Terminal Log -->
            <div class="h-32 border-t border-green-900 bg-black p-2 font-mono text-[11px] overflow-y-auto"
                id="terminal-container">
                <div id="terminal-logs" class="space-y-0.5">
                    <p class="opacity-50">root@ranksense-ent:~# ./init_core.sh</p>
                    <p class="opacity-50">System modules... [OK]</p>
                </div>
            </div>
        </section>

        <!-- Candidate Detail Inspector (Modal) -->
        <div id="candidateInspector"
            class="absolute inset-0 z-50 modal-bg hidden flex flex-col p-12 transition-all duration-300">
            <div class="hacker-border bg-black flex flex-col h-full relative p-6">
                <button onclick="closeInspector()"
                    class="absolute top-4 right-4 border border-red-500 text-red-500 px-3 py-1 hover:bg-red-900">X
                    CLOSE</button>

                <h2 class="text-2xl font-bold border-b border-green-800 pb-4 mb-4" id="inspector-title">
                    CANDIDATE_DETAILS</h2>

                <div class="grid grid-cols-2 gap-8 flex-1 overflow-hidden">
                    <!-- Left: Text Snippet -->
                    <div class="flex flex-col h-full gap-4">

                        <!-- Gap Analysis (Conditional) -->
                        <div id="inspector-gap-analysis" class="hidden flex-1 flex flex-col min-h-0">
                            <h3 class="text-sm font-bold mb-2">/// GAP_ANALYSIS (JD)</h3>
                            <div class="hacker-border p-2 flex-1 overflow-y-auto bg-black/50 text-[10px]">
                                <div class="mb-2">
                                    <span class="text-green-500 font-bold">MATCHED_KEYWORDS:</span>
                                    <div id="inspector-matches" class="flex flex-wrap gap-1 mt-1"></div>
                                </div>
                                <div>
                                    <span class="text-red-500 font-bold">MISSING_KEYWORDS:</span>
                                    <div id="inspector-missing" class="flex flex-wrap gap-1 mt-1"></div>
                                </div>
                                <div id="inspector-coverage" class="mt-2 text-xs font-bold text-blue-400"></div>
                            </div>
                        </div>

                        <div class="flex-1 flex flex-col min-h-0">
                            <h3 class="text-sm font-bold mb-2">/// EXTRACTED_SNIPPET (EVIDENCE)</h3>
                            <div class="bg-green-900/10 p-4 font-mono text-[10px] overflow-y-auto flex-1 border border-green-900/50"
                                id="inspector-snippet">
                                Loading...
                            </div>
                        </div>
                    </div>

                    <!-- Right: Metrics -->
                    <div class="flex flex-col space-y-4">
                        <h3 class="text-sm font-bold mb-2">/// PERFORMANCE_METRICS</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 border border-green-800">
                                <div class="text-[10px] opacity-70">TOTAL SCORE</div>
                                <div class="text-3xl font-bold" id="inspector-score">0.0</div>
                            </div>
                            <div class="p-4 border border-green-800">
                                <div class="text-[10px] opacity-70">INTERNSHIPS</div>
                                <div class="text-xl font-bold" id="inspector-intern">0</div>
                            </div>
                            <div class="p-4 border border-green-800">
                                <div class="text-[10px] opacity-70">PROJECTS</div>
                                <div class="text-xl font-bold" id="inspector-proj">0</div>
                            </div>
                            <div class="p-4 border border-green-800">
                                <div class="text-[10px] opacity-70">SKILL_COUNT</div>
                                <div class="text-xl font-bold" id="inspector-skill">0</div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <div class="text-[10px] opacity-70 mb-1">SKILLS_DETECTED</div>
                            <div class="text-[10px] text-green-300 flex flex-wrap gap-2" id="inspector-skills-list">
                                <!-- skills tags -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- Hacker Stats ---
        setInterval(() => {
            const now = new Date();
            document.getElementById('uptime').innerText = now.toISOString().split('T')[1].split('.')[0];
            document.getElementById('mem-usage').innerText = Math.floor(Math.random() * 5 + 10) + "GB";
        }, 1000);

        // --- Config ---
        const wsUrl = "ws://127.0.0.1:8000/ws/logs";
        const terminalLogs = document.getElementById('terminal-logs');
        const resultsTable = document.getElementById('resultsTable');

        let processedCount = 0;
        let ws = null;
        let reconnectInterval = null;
        let allCandidates = []; // Store all data for sorting and export

        function connectWebSocket() {
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                document.getElementById('net-status').innerText = "ONLINE";
                document.getElementById('net-status').classList.remove('text-red-500');
                document.getElementById('net-status').classList.add('text-green-500');
                addLog("> Uplink established.");
                if (reconnectInterval) { clearInterval(reconnectInterval); reconnectInterval = null; }
            };

            ws.onclose = () => {
                document.getElementById('net-status').innerText = "OFFLINE";
                document.getElementById('net-status').classList.replace('text-green-500', 'text-red-500');
                if (!reconnectInterval) {
                    addLog("! Link severed. Reattempting handshake...");
                    reconnectInterval = setInterval(connectWebSocket, 3000);
                }
            };

            ws.onmessage = (event) => {
                const msg = event.data;
                if (msg.startsWith("COMPLETE_JSON:")) {
                    const jsonStr = msg.replace("COMPLETE_JSON:", "");
                    handleCompletion(JSON.parse(jsonStr));
                } else if (!msg.startsWith("COMPLETE:")) {
                    addLog(msg);
                }
            };
        }


        // Initial Load
        connectWebSocket();
        fetchCandidates(); // Load history

        async function fetchCandidates() {
            try {
                const res = await fetch("http://127.0.0.1:8000/candidates");
                const data = await res.json();
                allCandidates = data; // Already sorted from backend
                renderTable();
                document.getElementById('record-count').innerText = allCandidates.length;
                if (data.length > 0) addLog(`> Restored ${data.length} records from archive.`);
            } catch (e) {
                console.log("History fetch failed (backend might be offline yet)");
            }
        }

        async function purgeDB() {
            if (!confirm("CONFIRM: WIPE ALL CANDIDATE DATA?")) return;
            try {
                await fetch("http://127.0.0.1:8000/candidates", { method: "DELETE" });
                allCandidates = [];
                renderTable();
                document.getElementById('record-count').innerText = 0;
                addLog("> DATABASE PURGED.");
                Toastify({ text: "DATABASE WIPED", backgroundColor: "red" }).showToast();
            } catch (e) {
                addLog(`! Purge Failed: ${e}`);
            }
        }

        async function handleFiles(files) {
            const jdText = document.getElementById('jdInput').value;
            for (let i = 0; i < files.length; i++) {
                const formData = new FormData();
                formData.append("file", files[i]);
                if (jdText) formData.append("jd_text", jdText);

                addLog(`> Transmitting: ${files[i].name}`);

                try {
                    await fetch("http://127.0.0.1:8000/upload", { method: "POST", body: formData });
                    Toastify({ text: `UPLOADED: ${files[i].name}`, backgroundColor: "#003300", style: { border: "1px solid #0f0", color: "#0f0" } }).showToast();
                } catch (e) {
                    addLog(`! Transmission Failure: ${e}`);
                }
            }
        }

        function handleCompletion(data) {
            processedCount++;
            document.getElementById('record-count').innerText = processedCount;

            // Add to master list and sort
            allCandidates.push(data);
            allCandidates.sort((a, b) => b.score - a.score); // Descending sort

            renderTable();
            updateStats(data);
            updateRadar(data);
        }

        function renderTable() {
            resultsTable.innerHTML = "";

            allCandidates.forEach((data, index) => {
                const rank = index + 1;
                const jdBadge = data.jd_present ? '<span class="text-[8px] border border-green-500 px-1 rounded ml-2">JD_MATCHED</span>' : '';
                const row = `
                    <tr class="hover:bg-green-900/20 transition-colors font-mono cursor-pointer group border-b border-green-900/20" onclick='openInspector(${index})' onmouseenter='previewCandidate(${index})'>
                        <td class="p-3 font-bold group-hover:text-white transition-colors">[#${rank.toString().padStart(2, '0')}]</td>
                        <td class="p-3 text-white">
                            ${data.filename}
                            ${jdBadge}
                        </td>
                        <td class="p-3">
                            <div class="flex items-center gap-2">
                                <div class="h-2 w-24 bg-green-900 rounded-sm overflow-hidden">
                                    <div class="h-full bg-green-400" style="width: ${data.score}%"></div>
                                </div>
                                <span class="font-bold text-green-400">${data.score}</span>
                            </div>
                        </td>
                        <td class="p-3 text-[10px] opacity-70 truncate max-w-xs">${data.skills.slice(0, 5).join(', ')}...</td>
                    </tr>
                `;
                resultsTable.innerHTML += row;
            });
        }

        // --- Inspector Logic ---
        function openInspector(index) {
            const data = allCandidates[index];
            document.getElementById('candidateInspector').classList.remove('hidden');

            document.getElementById('inspector-title').innerText = data.filename.toUpperCase();
            document.getElementById('inspector-score').innerText = data.score;
            document.getElementById('inspector-intern').innerText = data.internships;
            document.getElementById('inspector-proj').innerText = data.projects;
            document.getElementById('inspector-skill').innerText = data.skills_count;
            document.getElementById('inspector-snippet').innerText = data.raw_text || "No snippet data available.";

            // Gap Analysis
            const gapSection = document.getElementById('inspector-gap-analysis');
            if (data.jd_analysis && data.jd_analysis.jd_present) {
                gapSection.classList.remove('hidden');

                const matches = data.jd_analysis.matches || [];
                const missing = data.jd_analysis.missing || [];

                document.getElementById('inspector-matches').innerHTML = matches.length > 0
                    ? matches.map(m => `<span class="bg-green-900/50 px-1 border border-green-700 text-green-300">${m}</span>`).join('')
                    : '<span class="opacity-50">None</span>';

                document.getElementById('inspector-missing').innerHTML = missing.length > 0
                    ? missing.slice(0, 20).map(m => `<span class="bg-red-900/50 px-1 border border-red-700 text-red-300">${m}</span>`).join('') + (missing.length > 20 ? '...' : '')
                    : '<span class="opacity-50">None</span>';

                const total = matches.length + missing.length;
                const coverage = total > 0 ? Math.round((matches.length / total) * 100) : 0;
                document.getElementById('inspector-coverage').innerText = `COVERAGE_SCORE: ${coverage}%`;
            } else {
                gapSection.classList.add('hidden');
            }

            const skillsContainer = document.getElementById('inspector-skills-list');
            skillsContainer.innerHTML = data.skills.map(s => `<span class="border border-green-500 px-1 rounded">${s}</span>`).join('');

            updateRadar(data);
            updateStats(data);
        }

        function closeInspector() {
            document.getElementById('candidateInspector').classList.add('hidden');
        }

        function exportCSV() {
            if (allCandidates.length === 0) {
                Toastify({ text: "NO DATA TO EXPORT", backgroundColor: "#330000", style: { border: "1px solid red", color: "red" } }).showToast();
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,Rank,Filename,Score,Internships,Projects,Skills,CGPA\n";

            allCandidates.forEach((row, index) => {
                let rowStr = `${index + 1},${row.filename},${row.score},${row.internships},${row.projects},${row.skills_count},${row.cgpa}`;
                csvContent += rowStr + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "ranksense_report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function updateStats(data) {
            document.getElementById('stat-intern').innerText = data.internships;
            document.getElementById('stat-proj').innerText = data.projects;
            document.getElementById('stat-skill').innerText = data.skills_count;
            document.getElementById('stat-cgpa').innerText = data.cgpa;
        }

        // --- Radar Chart ---
        const ctx = document.getElementById('radarChart').getContext('2d');
        const radarData = {
            labels: ['INTERNSHIPS', 'SKILLS', 'PROJECTS', 'ACADEMICS', 'EXPERIENCE'],
            datasets: [{
                label: 'COMPETENCY_INDEX',
                data: [0, 0, 0, 0, 0],
                backgroundColor: 'rgba(10, 255, 10, 0.2)',
                borderColor: '#0aff0a',
                borderWidth: 2,
                pointBackgroundColor: '#0aff0a',
                pointBorderColor: '#fff'
            }]
        };

        const chart = new Chart(ctx, {
            type: 'radar',
            data: radarData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        angleLines: { color: '#003300' },
                        grid: { color: '#003300' },
                        pointLabels: { color: '#0aff0a', font: { family: 'JetBrains Mono', size: 10 } },
                        ticks: { display: false, backdropColor: 'transparent' },
                        suggestedMin: 0, suggestedMax: 10
                    }
                },
                plugins: { legend: { display: false } }
            }
        });

        function updateRadar(data) {
            const d = [
                Math.min(data.internships * 5, 10),
                Math.min(data.skills_count / 2, 10),
                Math.min(data.projects * 3.3, 10),
                Math.min(data.cgpa, 10),
                Math.min(data.experience * 5, 10)
            ];
            chart.data.datasets[0].data = d;
            chart.update();
        }

        function previewCandidate(index) {
            const data = allCandidates[index];
            updateStats(data);
            updateRadar(data);
            const title = document.querySelector('.hacker-border h3');
            if (title) title.innerHTML = "/// MATRIX: <span class='text-white'>" + data.filename.substring(0, 15) + "...</span>";
        }

        function addLog(msg) {
            const p = document.createElement('p');
            p.innerText = msg;
            if (msg.includes('!')) p.style.color = 'red';
            else if (msg.includes('>')) p.style.color = '#0aff0a';
            else p.style.color = '#00cc00';

            terminalLogs.appendChild(p);
            document.getElementById('terminal-container').scrollTop = terminalLogs.scrollHeight;
        }
    </script>
</body>

</html>